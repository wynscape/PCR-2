<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PCR Simulation</title>
    <style>
        :root {
            --blue: #3498db; --purple: #9b59b6; --green: #2ecc71;
            --brown: #795548; --gray: #f4f4f4; --dark: #333;
        }
        * { box-sizing: border-box; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        body { 
            margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; 
            background: #ffffff; color: var(--dark); overflow: hidden;
            display: flex; flex-direction: column; height: 100vh;
        }

        /* --- Header --- */
        #header { padding: 15px 20px; border-bottom: 1px solid #eee; text-align: center; }
        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 2px; font-weight: 800; }

        /* --- Main Layout --- */
        #main { flex: 1; display: flex; position: relative; overflow: hidden; }
        
        /* --- Animation Stage --- */
        #stage { flex: 2; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; border-right: 1px solid #eee; }
        .cycle-label { position: absolute; top: 10px; left: 10px; font-size: 0.7rem; color: #999; font-weight: bold; }

        /* --- Margin Tracker --- */
        #margin { flex: 1; background: #fafafa; padding: 10px; display: flex; flex-direction: column; overflow-y: auto; }
        .yield-box { margin-bottom: 20px; }
        .yield-title { font-size: 0.65rem; font-weight: bold; color: #888; text-transform: uppercase; margin-bottom: 8px; border-bottom: 1px solid #ddd; padding-bottom: 3px; }
        .symbol-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(30px, 1fr)); gap: 5px; }
        
        /* DNA Symbols in Margin */
        .dna-icon { height: 6px; border-radius: 2px; }
        .long-icon { background: linear-gradient(90deg, var(--blue) 20%, var(--green) 80%); }
        .short-icon { background: linear-gradient(90deg, var(--purple) 20%, var(--green) 80%); }

        /* --- DNA Animation Elements --- */
        .dna-container { position: relative; width: 80%; height: 150px; }
        .strand { position: absolute; width: 100%; height: 10px; border-radius: 5px; transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .template { background: var(--blue); }
        .new-growth { background: var(--green); height: 0; width: 0; right: 0; }
        .p-mark { position: absolute; width: 25px; height: 14px; background: var(--purple); border-radius: 3px; opacity: 0; }
        .pol-dot { position: absolute; width: 18px; height: 18px; background: var(--brown); border-radius: 50%; opacity: 0; transform: translate(-50%, -50%); z-index: 10; }

        /* --- Controls --- */
        #controls { padding: 20px; border-top: 1px solid #eee; display: flex; justify-content: center; align-items: center; gap: 15px; background: white; }
        button {
            padding: 12px 25px; font-size: 0.9rem; font-weight: bold; border: none; border-radius: 8px;
            background: var(--dark); color: white; cursor: pointer; transition: 0.2s;
        }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        #step-info { font-size: 0.8rem; font-weight: 600; color: var(--purple); width: 150px; text-align: center; }

        /* Mobile specific adjustments */
        @media (max-width: 600px) {
            #main { flex-direction: column; }
            #stage { height: 50%; border-right: none; border-bottom: 1px solid #eee; }
            #margin { height: 50%; }
        }
    </style>
</head>
<body>

    <div id="header"><h1>PCR</h1></div>

    <div id="main">
        <div id="stage">
            <div class="cycle-label" id="cycle-display">CYCLE: 0</div>
            <div id="step-info">Ready to start</div>
            
            <div class="dna-container">
                <!-- Animation elements -->
                <div id="top-template" class="strand template" style="top: 30%;"></div>
                <div id="bot-template" class="strand template" style="bottom: 30%;"></div>
                
                <div id="primer-top" class="p-mark" style="top: 35%; left: 0;"></div>
                <div id="primer-bot" class="p-mark" style="bottom: 35%; right: 0;"></div>
                
                <div id="ext-top" class="strand new-growth" style="top: 30%; right: 0;"></div>
                <div id="ext-bot" class="strand new-growth" style="bottom: 30%; left: 0;"></div>
                
                <div id="pol" class="pol-dot"></div>
            </div>
        </div>

        <div id="margin">
            <div class="yield-box">
                <div class="yield-title">Linear (Long Fragments)</div>
                <div id="linear-list" class="symbol-grid"></div>
            </div>
            <div class="yield-box">
                <div class="yield-title">Exponential (Target Short)</div>
                <div id="expo-list" class="symbol-grid"></div>
            </div>
        </div>
    </div>

    <div id="controls">
        <button id="run-btn" onclick="startCycle()">RUN NEXT CYCLE</button>
        <button style="background:#eee; color:#666" onclick="location.reload()">RESET</button>
    </div>

    <script>
        /* --- SECURITY --- */
        if (!window.location.hostname.includes('wynscape.github.io') && !window.location.hostname.includes('localhost')) {
            document.body.innerHTML = "<div style='padding:50px;text-align:center;'>Access Restricted.</div>";
        }
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.onkeydown = e => { if(e.keyCode == 123 || (e.ctrlKey && e.shiftKey && e.keyCode == 73)) return false; };

        /* --- LOGIC --- */
        let currentCycle = 0;
        let isRunning = false;

        async function startCycle() {
            if (isRunning || currentCycle >= 5) return;
            isRunning = true;
            currentCycle++;
            document.getElementById('run-btn').disabled = true;
            document.getElementById('cycle-display').innerText = "CYCLE: " + currentCycle;

            const stepInfo = document.getElementById('step-info');

            // 1. Denaturation
            stepInfo.innerText = "Denaturation (95°C)";
            document.getElementById('top-template').style.top = "10%";
            document.getElementById('bot-template').style.bottom = "10%";
            await wait(1000);

            // 2. Annealing
            stepInfo.innerText = "Annealing (55°C)";
            document.getElementById('primer-top').style.opacity = "1";
            document.getElementById('primer-bot').style.opacity = "1";
            await wait(800);

            // 3. Extension
            stepInfo.innerText = "Extension (72°C)";
            const pol = document.getElementById('pol');
            const eT = document.getElementById('ext-top');
            const eB = document.getElementById('ext-bot');
            
            pol.style.opacity = "1";
            eT.style.height = "10px";
            eB.style.height = "10px";

            for(let i=0; i<=100; i+=5) {
                eT.style.width = i + "%";
                eB.style.width = i + "%";
                pol.style.left = i + "%";
                pol.style.top = (Math.random() > 0.5 ? "10%" : "90%");
                await wait(30);
            }

            // Update Margin
            updateMargin();

            await wait(600);
            resetVisuals();
            stepInfo.innerText = "Cycle " + currentCycle + " Finished";
            isRunning = false;
            if (currentCycle < 5) document.getElementById('run-btn').disabled = false;
            else stepInfo.innerText = "5 Cycles Complete";
        }

        function updateMargin() {
            // Math Logic
            // Long fragments (Linear) = 2 * Cycle
            // Target fragments (Exponential) = 2^Cycle - (2 * Cycle)
            const linearCount = currentCycle * 2;
            const total = Math.pow(2, currentCycle);
            const expoCount = currentCycle < 3 ? 0 : total - linearCount;

            const linList = document.getElementById('linear-list');
            const expList = document.getElementById('expo-list');

            linList.innerHTML = '';
            for(let i=0; i<linearCount; i++) {
                linList.innerHTML += '<div class="dna-icon long-icon"></div>';
            }

            expList.innerHTML = '';
            for(let i=0; i<expoCount; i++) {
                expList.innerHTML += '<div class="dna-icon short-icon"></div>';
            }
        }

        function resetVisuals() {
            document.getElementById('top-template').style.top = "30%";
            document.getElementById('bot-template').style.bottom = "30%";
            document.getElementById('primer-top').style.opacity = "0";
            document.getElementById('primer-bot').style.opacity = "0";
            document.getElementById('ext-top').style.width = "0";
            document.getElementById('ext-bot').style.width = "0";
            document.getElementById('pol').style.opacity = "0";
        }

        function wait(ms) { return new Promise(r => setTimeout(r, ms)); }
    </script>
</body>
</html>
